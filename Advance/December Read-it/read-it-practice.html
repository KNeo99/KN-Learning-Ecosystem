<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Read-it Practice</title>
<style>
* { margin: 0; padding: 0; box-sizing: border-box; }
body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif; background: linear-gradient(135deg, #667eea 0%, #764ba2 50%, #f093fb 100%); min-height: 100vh; display: flex; justify-content: center; align-items: center; padding: 10px; }
.container { background: white; border-radius: 20px; box-shadow: 0 20px 60px rgba(0,0,0,0.3); max-width: 1000px; width: 100%; padding: 20px; max-height: 95vh; overflow-y: auto; }
.header { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 15px; border-radius: 15px; text-align: center; margin-bottom: 15px; }
.header h1 { font-size: 2em; margin-bottom: 5px; }
.header p { font-size: 1em; opacity: 0.9; }
.consent-screen { display: block; }
.setup-screen { display: none; }
.practice-screen { display: none; }
.section { background: #f8f9fa; border-radius: 15px; padding: 15px; margin: 10px 0; }
.section h2 { font-size: 1.5em; color: #4c51bf; margin-bottom: 10px; }
.info-box { background: white; border-radius: 12px; padding: 20px; margin: 15px 0; }
.info-box h3 { color: #667eea; margin-bottom: 15px; }
.info-box ul { list-style: none; padding: 0; }
.info-box li { margin: 12px 0; padding-left: 25px; position: relative; }
.info-box li span { position: absolute; left: 0; }
.warning-box { background: #fff9e6; border: 3px solid #ffc107; border-radius: 12px; padding: 15px; margin: 15px 0; }
.content-tabs { display: flex; gap: 5px; margin-bottom: 10px; }
.tab { flex: 1; background: white; border: 2px solid #e0e0e0; padding: 8px; border-radius: 8px; cursor: pointer; text-align: center; font-weight: bold; font-size: 0.9em; transition: all 0.3s; }
.tab:hover { background: #f0f0f0; }
.tab.active { background: #667eea; color: white; border-color: #667eea; }
.tab-content { display: none; }
.tab-content.active { display: block; }
.lesson-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 10px; margin: 10px 0; }
.lesson-card { background: white; border: 3px solid #e0e0e0; border-radius: 10px; padding: 12px; cursor: pointer; transition: all 0.3s; }
.lesson-card:hover { transform: translateY(-5px); box-shadow: 0 10px 20px rgba(0,0,0,0.1); }
.lesson-card.selected { border-color: #667eea; background: #ebf4ff; }
.lesson-icon { font-size: 2em; margin-bottom: 5px; }
.lesson-title { font-size: 1em; font-weight: bold; color: #333; margin-bottom: 5px; }
.lesson-duration { color: #666; font-size: 0.8em; }
textarea { width: 100%; min-height: 120px; padding: 12px; border: 2px solid #e0e0e0; border-radius: 10px; font-size: 1em; font-family: inherit; resize: vertical; }
.file-upload { background: white; border: 3px dashed #667eea; border-radius: 10px; padding: 20px; text-align: center; cursor: pointer; transition: all 0.3s; }
.file-upload:hover { background: #f0f5ff; }
.file-upload input { display: none; }
.file-upload h3 { font-size: 1.1em; margin: 8px 0; }
.file-upload p { font-size: 0.9em; }
.file-name { margin-top: 10px; font-weight: bold; color: #667eea; font-size: 0.9em; }
.btn-primary { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; padding: 12px 30px; font-size: 1.2em; font-weight: bold; border-radius: 12px; cursor: pointer; width: 100%; margin: 10px 0; transition: transform 0.2s; }
.btn-primary:hover:not(:disabled) { transform: scale(1.05); }
.btn-primary:disabled { opacity: 0.6; cursor: not-allowed; }
.story-display { background: #fff9e6; border: 3px solid #ffc107; border-radius: 12px; padding: 15px; margin: 10px 0; font-size: 1em; line-height: 1.6; }
.story-display h3 { color: #f57c00; margin-bottom: 10px; font-size: 1.2em; }
#storyContent { white-space: pre-wrap; word-wrap: break-word; }
.controls { display: flex; gap: 10px; margin: 15px 0; }
.btn-control { flex: 1; padding: 15px; font-size: 1.2em; font-weight: bold; border-radius: 12px; border: none; cursor: pointer; transition: all 0.3s; }
.btn-start { background: linear-gradient(135deg, #4caf50 0%, #2196f3 100%); color: white; }
.btn-stop { background: linear-gradient(135deg, #ff6b6b 0%, #ee5a6f 100%); color: white; }
.btn-control:hover:not(:disabled) { transform: scale(1.05); }
.btn-control:disabled { opacity: 0.6; cursor: not-allowed; }
.recording-indicator { background: #fee; border: 3px solid #e74c3c; border-radius: 12px; padding: 12px; text-align: center; margin: 10px 0; display: none; font-size: 0.95em; }
.recording-indicator.active { display: block; animation: pulse 1.5s infinite; }
@keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.7; } }
.recording-dot { display: inline-block; width: 15px; height: 15px; background: #e74c3c; border-radius: 50%; margin-right: 10px; animation: blink 1s infinite; }
@keyframes blink { 0%, 100% { opacity: 1; } 50% { opacity: 0; } }
.results { background: #e8f5e9; border: 3px solid #4caf50; border-radius: 12px; padding: 15px; margin: 10px 0; display: none; }
.results.show { display: block; }
.comparison-section { background: white; border-radius: 12px; padding: 15px; margin: 15px 0; }
.comparison-section h3 { color: #333; margin-bottom: 10px; font-size: 1.2em; }
.text-box { background: #f8f9fa; border-radius: 10px; padding: 20px; }
.text-box-content { font-size: 0.95em; line-height: 1.6; color: #333; max-height: 200px; overflow-y: auto; }
.score-circle { width: 140px; height: 140px; border-radius: 50%; background: white; border: 8px solid #4caf50; display: flex; flex-direction: column; align-items: center; justify-content: center; margin: 15px auto; }
.score-value { font-size: 2.2em; font-weight: bold; color: #4caf50; }
.score-label { font-size: 1em; color: #666; }
.messages { background: #f8f9fa; border-radius: 12px; padding: 12px; margin: 10px 0; max-height: 120px; overflow-y: auto; }
.message { margin: 6px 0; padding: 10px; border-radius: 8px; font-size: 0.95em; }
.message.bot { background: #e3f2fd; color: #1976d2; }
.hidden { display: none; }
.error-box { background: #ffebee; border: 3px solid #f44336; border-radius: 12px; padding: 12px; margin: 10px 0; color: #c62828; font-size: 0.95em; }
</style>
</head>
<body>
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
<script>
if (typeof pdfjsLib !== 'undefined') {
pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
}
</script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/mammoth/1.6.0/mammoth.browser.min.js"></script>

<div class="container">
<div class="header">
<h1>üìö Read-it Practice</h1>
<p>Improve your reading skills with AI-powered practice</p>
</div>

<!-- CONSENT SCREEN -->
<div id="consentScreen" class="consent-screen">
<div class="section">
<h2>üéôÔ∏è Microphone Access Required</h2>
<div class="info-box">
<h3>üìã How This Works:</h3>
<ul>
<li><span>‚úì</span> <strong>Your voice will be recorded</strong> to assess your reading accuracy</li>
<li><span>‚úì</span> <strong>Recordings are NOT saved</strong> - processed in real-time only</li>
<li><span>‚úì</span> <strong>Privacy protected</strong> - no data is stored or shared</li>
<li><span>‚úì</span> <strong>Permission required</strong> - your browser will ask for microphone access</li>
</ul>
</div>
<div class="warning-box">
<strong>‚ö†Ô∏è Important:</strong> By clicking "I Agree" below, you consent to microphone use for this practice session only.
</div>
<div id="errorBox" class="error-box hidden"></div>
<button class="btn-primary" onclick="requestMicrophoneAccess()" id="agreeBtn">
üé§ I Agree - Allow Microphone Access
</button>
</div>
</div>

<!-- SETUP SCREEN -->
<div id="setupScreen" class="setup-screen">
<div class="section">
<h2>üìñ Choose Your Reading Material</h2>
<div class="content-tabs">
<div class="tab active" onclick="switchTab('lessons')">üìö History Lessons</div>
<div class="tab" onclick="switchTab('paste')">‚úèÔ∏è Paste Text</div>
<div class="tab" onclick="switchTab('upload')">üìÑ Upload File</div>
</div>

<div id="lessonsTab" class="tab-content active">
<div class="lesson-grid">
<div class="lesson-card" onclick="selectLesson(0)">
<div class="lesson-icon">üö¢</div>
<div class="lesson-title">The Mayflower Voyage</div>
<div class="lesson-duration">‚è±Ô∏è 2-3 minutes</div>
</div>
<div class="lesson-card" onclick="selectLesson(1)">
<div class="lesson-icon">üóΩ</div>
<div class="lesson-title">Declaration of Independence</div>
<div class="lesson-duration">‚è±Ô∏è 2-3 minutes</div>
</div>
<div class="lesson-card" onclick="selectLesson(2)">
<div class="lesson-icon">‚ö°</div>
<div class="lesson-title">The Industrial Revolution</div>
<div class="lesson-duration">‚è±Ô∏è 2-3 minutes</div>
</div>
</div>
</div>

<div id="pasteTab" class="tab-content">
<textarea id="pasteText" placeholder="Paste your text here for reading practice..."></textarea>
</div>

<div id="uploadTab" class="tab-content">
<div class="file-upload" onclick="document.getElementById('fileInput').click()">
<div style="font-size: 3em;">üìÅ</div>
<h3>Click to Upload File</h3>
<p>Supports .txt, .pdf, .doc, .docx files</p>
<input type="file" id="fileInput" accept=".txt,.pdf,.doc,.docx" onchange="handleFileUpload(event)">
<div id="fileName" class="file-name"></div>
</div>
<div id="fileError" class="hidden" style="color: #f44336; margin-top: 15px; text-align: center; font-weight: bold;"></div>
</div>
</div>

<div id="errorBox2" class="error-box hidden"></div>
<button class="btn-primary" onclick="startPractice()">üöÄ Start Reading Practice</button>
</div>

<!-- PRACTICE SCREEN -->
<div id="practiceScreen" class="practice-screen">
<div class="messages" id="messages"></div>
<div class="story-display" id="storyDisplay">
<h3 id="storyTitle">Reading Passage</h3>
<div id="storyContent"></div>
</div>
<div class="recording-indicator" id="recordingIndicator">
<span class="recording-dot"></span>
<strong>üé§ Recording in progress... Speak clearly!</strong>
</div>
<div class="controls">
<button id="startBtn" class="btn-control btn-start" onclick="startRecording()">üé§ Start Reading</button>
<button id="stopBtn" class="btn-control btn-stop hidden" onclick="stopRecording()">‚èπÔ∏è Stop Reading</button>
</div>

<div id="results" class="results">
<h2 style="text-align: center; color: #4caf50; margin-bottom: 20px;">üéâ Reading Results</h2>
<div class="score-circle">
<div class="score-value" id="scoreValue">0%</div>
<div class="score-label">Accuracy</div>
</div>
<div style="text-align: center; margin: 20px 0; padding: 20px; background: white; border-radius: 15px;">
<p style="font-size: 1.2em; color: #666; line-height: 1.8;">
<strong>üìä What is Accuracy?</strong><br>
Accuracy shows how closely your reading matched the original text. 
It compares each word you spoke with the correct words in the passage. 
A higher percentage means you read more words correctly!
</p>
</div>
<div class="comparison-section">
<h3>üé§ What You Read</h3>
<div class="text-box">
<div class="text-box-content" id="userRecordedText">
Your recorded text will appear here...
</div>
</div>
</div>
<button class="btn-primary" onclick="resetPractice()">üîÑ Try Another Practice</button>
</div>
</div>
</div>

<script>
let selectedVoice = 'female';
let selectedContent = null;
let recognition = null;
let isRecording = false;
let recordedTranscript = '';
let microphoneGranted = false;
let instructionsGiven = false;

const lessons = [
{
title: "The Mayflower Voyage",
text: "In September 1620, a small ship called the Mayflower set sail from England. Aboard were 102 passengers seeking religious freedom and a new life in America. The journey across the Atlantic Ocean was treacherous, lasting 66 days through storms and rough seas. Many passengers became sick during the voyage. When they finally reached the shores of what is now Massachusetts, they faced a harsh winter. Nearly half of the passengers did not survive. But those who remained persevered, establishing Plymouth Colony. They formed a agreement called the Mayflower Compact, creating a foundation for self-governance. With help from Native Americans, particularly Squanto, they learned to grow crops and hunt. Their first successful harvest led to a celebration of thanksgiving. This small group of determined settlers became known as the Pilgrims, and their courage helped shape the future of America."
},
{
title: "Declaration of Independence",
text: "In the summer of 1776, thirteen American colonies stood at a crossroads. For years, they had been under British rule, paying taxes without representation in Parliament. Tensions had been building, and conflict seemed inevitable. A group of colonial leaders gathered in Philadelphia for the Continental Congress. They faced a momentous decision: should they declare independence from Britain? Thomas Jefferson, a young lawyer from Virginia, was chosen to draft a document. Working late into the nights, he wrote words that would echo through history. He declared that all men are created equal and have unalienable rights to life, liberty, and the pursuit of happiness. On July 4, 1776, the Congress adopted the Declaration of Independence. It was a bold and dangerous move, as it meant war with the most powerful nation on Earth. But the founders believed in their cause. They signed their names, knowing they could be executed for treason. Their courage gave birth to a new nation."
},
{
title: "The Industrial Revolution",
text: "In the late 1700s, America began to transform from a farming society into an industrial powerhouse. This period, known as the Industrial Revolution, changed every aspect of American life. It began in England with new inventions like the steam engine and spinning jenny. These innovations soon crossed the Atlantic to America. Samuel Slater, often called the Father of the American Industrial Revolution, built the first textile mill in Rhode Island. Factories began appearing along rivers, using water power to run machines. People left their farms to work in cities. The invention of the cotton gin by Eli Whitney revolutionized cotton production in the South. Railroads expanded across the nation, connecting distant cities and enabling trade. Factories produced goods faster and cheaper than ever before. However, this progress came at a cost. Workers, including children, labored long hours in dangerous conditions. Cities became crowded and polluted. Yet the Industrial Revolution laid the foundation for American economic power and changed the nation forever."
}
];

async function requestMicrophoneAccess() {
const errorBox = document.getElementById('errorBox');
const agreeBtn = document.getElementById('agreeBtn');
errorBox.classList.add('hidden');
agreeBtn.disabled = true;
agreeBtn.textContent = '‚è≥ Requesting permission...';

if (!('webkitSpeechRecognition' in window) && !('SpeechRecognition' in window)) {
errorBox.textContent = '‚ùå Speech recognition not supported. Please use Chrome, Edge, or Safari.';
errorBox.classList.remove('hidden');
agreeBtn.disabled = false;
agreeBtn.textContent = 'üé§ I Agree - Allow Microphone Access';
return;
}

try {
const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
stream.getTracks().forEach(track => track.stop());
microphoneGranted = true;

const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
recognition = new SpeechRecognition();
recognition.continuous = true;
recognition.interimResults = true;
recognition.lang = 'en-US';

recognition.onresult = (event) => {
for (let i = event.resultIndex; i < event.results.length; i++) {
if (event.results[i].isFinal) {
recordedTranscript += event.results[i][0].transcript + ' ';
}
}
};

recognition.onerror = (event) => {
if (event.error !== 'no-speech' && event.error !== 'aborted') {
console.error('Recognition error:', event.error);
}
};

document.getElementById('consentScreen').style.display = 'none';
document.getElementById('setupScreen').style.display = 'block';

// Speak instructions only once - with longer delay for iOS
if (!instructionsGiven) {
instructionsGiven = true;

// Wait for screen transition and voices to load
setTimeout(() => {
// Force load voices for iOS
if ('speechSynthesis' in window) {
window.speechSynthesis.getVoices();
}
}, 200);

// Speak instructions after voices are ready
setTimeout(() => {
const instructions = "Welcome to Read-it Practice! Thank you for allowing microphone access. Choose your reading material from the options below. You can select a history lesson, paste your own text, or upload a document. Once you've chosen, I'll read the passage to you, then you'll read it back to me. Click Start Reading to begin, and Stop Reading when finished. I'll give you an accuracy score. Let's get started!";
speakTextIOS(instructions);
}, 1000);
}

} catch (error) {
errorBox.innerHTML = `<strong>‚ùå Microphone Access Denied</strong><br><br>Please allow microphone access:<br><br><strong>iOS Safari:</strong> Settings ‚Üí Safari ‚Üí Microphone ‚Üí Allow<br><strong>Chrome/Edge:</strong> Click üîí ‚Üí Site Settings ‚Üí Microphone ‚Üí Allow<br><strong>Firefox:</strong> Click üîí ‚Üí Permissions ‚Üí Microphone ‚Üí Allow<br><br>Refresh after allowing.`;
errorBox.classList.remove('hidden');
agreeBtn.disabled = false;
agreeBtn.textContent = 'üé§ I Agree - Allow Microphone Access';
}
}

function switchTab(tab) {
document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
event.target.classList.add('active');
document.getElementById(tab + 'Tab').classList.add('active');
}

function selectLesson(index) {
selectedContent = lessons[index];
document.querySelectorAll('.lesson-card').forEach(card => card.classList.remove('selected'));
event.target.closest('.lesson-card').classList.add('selected');
}

function handleFileUpload(event) {
const file = event.target.files[0];
const fileError = document.getElementById('fileError');
const fileName = document.getElementById('fileName');
fileError.classList.add('hidden');
fileName.textContent = '';

if (!file) return;

const fileType = file.type;
const fileExtension = file.name.split('.').pop().toLowerCase();

if (fileType === 'text/plain' || fileExtension === 'txt') {
const reader = new FileReader();
reader.onload = function(e) {
selectedContent = { title: file.name.replace('.txt', ''), text: e.target.result };
fileName.textContent = `‚úÖ ${file.name} loaded successfully`;
};
reader.onerror = function() {
fileError.textContent = '‚ùå Error reading text file. Please try again.';
fileError.classList.remove('hidden');
};
reader.readAsText(file);
} else if (fileType === 'application/pdf' || fileExtension === 'pdf') {
fileName.textContent = `‚è≥ Loading ${file.name}...`;
const reader = new FileReader();
reader.onload = async function(e) {
try {
const loadingTask = pdfjsLib.getDocument({data: e.target.result});
const pdf = await loadingTask.promise;
let fullText = '';
for (let i = 1; i <= pdf.numPages; i++) {
const page = await pdf.getPage(i);
const textContent = await page.getTextContent();
const pageText = textContent.items.map(item => item.str).join(' ');
fullText += pageText + ' ';
}
if (fullText.trim()) {
selectedContent = { title: file.name.replace('.pdf', ''), text: fullText.trim() };
fileName.textContent = `‚úÖ ${file.name} loaded successfully`;
} else {
fileError.textContent = '‚ùå No text found in PDF. Please try a different file.';
fileError.classList.remove('hidden');
}
} catch (error) {
fileError.textContent = '‚ùå Error reading PDF file. Please try again.';
fileError.classList.remove('hidden');
}
};
reader.readAsArrayBuffer(file);
} else if (fileType === 'application/vnd.openxmlformats-officedocument.wordprocessingml.document' || fileExtension === 'docx' || fileExtension === 'doc') {
fileName.textContent = `‚è≥ Loading ${file.name}...`;
const reader = new FileReader();
reader.onload = async function(e) {
try {
const result = await mammoth.extractRawText({arrayBuffer: e.target.result});
const text = result.value;
if (text.trim()) {
selectedContent = { title: file.name.replace(/\.(docx|doc)$/, ''), text: text.trim() };
fileName.textContent = `‚úÖ ${file.name} loaded successfully`;
} else {
fileError.textContent = '‚ùå No text found in document. Please try a different file.';
fileError.classList.remove('hidden');
}
} catch (error) {
fileError.textContent = '‚ùå Error reading Word document. Please try again.';
fileError.classList.remove('hidden');
}
};
reader.readAsArrayBuffer(file);
} else {
fileError.textContent = '‚ùå Unsupported file type. Please upload .txt, .pdf, .doc, or .docx files.';
fileError.classList.remove('hidden');
}
}

async function startPractice() {
const errorBox2 = document.getElementById('errorBox2');
errorBox2.classList.add('hidden');

if (!microphoneGranted || !recognition) {
errorBox2.textContent = '‚ö†Ô∏è Please allow microphone access first by clicking "I Agree"';
errorBox2.classList.remove('hidden');
return;
}

const pasteText = document.getElementById('pasteText').value.trim();
if (pasteText) {
selectedContent = { title: 'Your Custom Text', text: pasteText };
}

if (!selectedContent) {
errorBox2.textContent = '‚ö†Ô∏è Please select a lesson, paste text, or upload a file';
errorBox2.classList.remove('hidden');
return;
}

document.getElementById('setupScreen').style.display = 'none';
document.getElementById('practiceScreen').style.display = 'block';

document.getElementById('storyTitle').textContent = selectedContent.title;
document.getElementById('storyContent').textContent = selectedContent.text;

addMessage(`üéØ Practicing: "${selectedContent.title}"`);
addMessage('üîä Listen as I read the passage...');

// Only read the passage, no instructions
speakTextIOS(selectedContent.text);

setTimeout(() => {
addMessage('‚úÖ Your turn! Click "Start Reading" when ready.');
}, calculateReadTime(selectedContent.text) + 1000);
}

function speakTextIOS(text) {
if ('speechSynthesis' in window) {
// Cancel any existing speech
window.speechSynthesis.cancel();

// iOS needs voices to be loaded first
const voices = window.speechSynthesis.getVoices();
console.log('Available voices:', voices.length);

// Wait a bit longer for iOS to be ready
setTimeout(() => {
const utterance = new SpeechSynthesisUtterance(text);

// Get voices again to ensure they're loaded
const voicesList = window.speechSynthesis.getVoices();

if (selectedVoice === 'female') {
// Try multiple female voice options for iOS
const femaleVoice = voicesList.find(v => 
v.lang.includes('en-US') && (
v.name.includes('Samantha') || 
v.name.includes('Victoria') || 
v.name.includes('Karen') || 
v.name.includes('Moira') || 
v.name.includes('Female') || 
v.name.includes('Fiona') ||
v.name.includes('Susan')
)
);
if (femaleVoice) {
utterance.voice = femaleVoice;
console.log('Using voice:', femaleVoice.name);
}
}

utterance.rate = 0.85;
utterance.pitch = 1;
utterance.volume = 1;
utterance.lang = 'en-US';

utterance.onstart = () => {
console.log('Speech started on iOS');
};

utterance.onend = () => {
console.log('Speech ended on iOS');
};

utterance.onerror = (event) => {
console.error('Speech error on iOS:', event);
};

// Speak
window.speechSynthesis.speak(utterance);
console.log('Speech utterance queued');
}, 150);
}
}

function speakText(text) { speakTextIOS(text); }

function calculateReadTime(text) {
const words = text.split(/\s+/).length;
return (words / 150) * 60 * 1000;
}

function addMessage(text) {
const messages = document.getElementById('messages');
const messageDiv = document.createElement('div');
messageDiv.className = 'message bot';
messageDiv.textContent = text;
messages.appendChild(messageDiv);
messages.scrollTop = messages.scrollHeight;
}

function startRecording() {
if (recognition && !isRecording) {
recordedTranscript = '';
isRecording = true;
recognition.start();
document.getElementById('startBtn').classList.add('hidden');
document.getElementById('stopBtn').classList.remove('hidden');
document.getElementById('recordingIndicator').classList.add('active');
addMessage('üé§ Recording started! Read the passage above.');
}
}

function stopRecording() {
if (recognition && isRecording) {
isRecording = false;
recognition.stop();
document.getElementById('startBtn').classList.remove('hidden');
document.getElementById('stopBtn').classList.add('hidden');
document.getElementById('recordingIndicator').classList.remove('active');
addMessage('‚èπÔ∏è Recording stopped. Analyzing...');
setTimeout(() => analyzeReading(), 1000);
}
}

function analyzeReading() {
const userText = recordedTranscript.trim();
const originalText = selectedContent.text;

if (!userText) {
addMessage('‚ùå No speech detected. Please try again and speak louder.');
return;
}

document.getElementById('userRecordedText').textContent = userText;

const originalWords = originalText.toLowerCase().split(/\s+/);
const userWords = userText.toLowerCase().split(/\s+/);
const minLength = Math.min(originalWords.length, userWords.length);

let correctWords = 0;
for (let i = 0; i < minLength; i++) {
const origWord = originalWords[i].replace(/[.,!?;:]/g, '');
const userWord = userWords[i].replace(/[.,!?;:]/g, '');
if (origWord === userWord) correctWords++;
}

const accuracy = Math.round((correctWords / originalWords.length) * 100);

document.getElementById('scoreValue').textContent = accuracy + '%';
document.getElementById('results').classList.add('show');

const circle = document.querySelector('.score-circle');
const scoreValue = document.querySelector('.score-value');
if (accuracy >= 90) {
circle.style.borderColor = '#4caf50';
scoreValue.style.color = '#4caf50';
addMessage('üåü Excellent! Outstanding reading accuracy!');
speakText(`Excellent job! You scored ${accuracy} percent accuracy!`);
} else if (accuracy >= 70) {
circle.style.borderColor = '#ff9800';
scoreValue.style.color = '#ff9800';
addMessage('üëç Good job! Keep practicing!');
speakText(`Good job! You scored ${accuracy} percent accuracy!`);
} else {
circle.style.borderColor = '#f44336';
scoreValue.style.color = '#f44336';
addMessage('üí™ Keep practicing!');
speakText(`You scored ${accuracy} percent accuracy. Keep practicing!`);
}
}

function resetPractice() {
// Hide practice and results screens
document.getElementById('practiceScreen').style.display = 'none';
document.getElementById('results').classList.remove('show');

// Clear previous content selection
selectedContent = null;
document.querySelectorAll('.lesson-card').forEach(card => card.classList.remove('selected'));
document.getElementById('pasteText').value = '';
document.getElementById('fileName').textContent = '';

// Show setup screen (skip consent since already granted)
document.getElementById('setupScreen').style.display = 'block';

// Clear messages
document.getElementById('messages').innerHTML = '';

// Reset recording state
recordedTranscript = '';
isRecording = false;
}

if ('speechSynthesis' in window) {
let voicesLoaded = false;
const loadVoices = () => {
const voices = window.speechSynthesis.getVoices();
if (voices.length > 0) {
voicesLoaded = true;
console.log('Voices loaded:', voices.length);
}
};
loadVoices();
if (window.speechSynthesis.onvoiceschanged !== undefined) {
window.speechSynthesis.onvoiceschanged = loadVoices;
}
document.addEventListener('click', () => {
if (!voicesLoaded) loadVoices();
}, { once: true });
}
</script>
</body>
</html>